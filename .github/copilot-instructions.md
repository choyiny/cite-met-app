# AI Coding Agent Guide for `cite-met-app`

Purpose: Enable rapid, safe contributions to this Cloudflare Workers + React (Vite) monorepo integrating Better Auth, Stripe, Drizzle ORM (D1), and autogenerated OpenAPI docs.

## High-Level Architecture
- Runtime: Single Cloudflare Worker (`wrangler.jsonc` main: `src/index.ts`) built with Hono + `@hono/zod-openapi` for typed routes & automatic `/doc` OpenAPI spec and `/swagger-ui` viewer.
- Auth: Centralized Better Auth config in `src/auth/index.ts` exposes `createAuth()`; adds plugins (anonymous, admin, passkey, stripe). Stripe plugin dynamically loads plans from DB (table `plans`). CLI code-gen (schemas/migrations) reuses same config without an env.
- Database: Cloudflare D1 (SQLite). Drizzle ORM schema stitched from multiple files: core tables in `src/db/schema.ts` (not yet read here) plus auth-generated tables in `src/db/auth.schema.ts` and payment tables in `src/db/payment.schema.ts`. Drizzle config (`drizzle.config.ts`) dynamically chooses local file vs remote HTTP driver.
- Request Lifecycle (`src/index.ts`): Global middlewares order: Sentry -> `injectDb` (sets `db`) -> logger -> CORS -> auth bootstrap (sets `auth`, `user`). Routes then mounted: `/api/auth/*` (Better Auth handler passthrough), `/api/plans/` (protected plan routes). Catch-all GET serves static assets from `public` (bundled frontend) with SPA fallback to `index.html`.
- Frontend: Separate Vite React app in `cite-met-app-frontend/` built and copied into backend `public/` via `build-frontend*.sh` scripts (replaces entire `public`). Uses alias `@` -> `./src` and excludes `better-auth` from optimizeDeps. Consumes OpenAPI spec optionally (spec sync script `sync-openapi.js`).

## Key Conventions & Patterns
- Context Passing: Hono `c.set()` used to attach `auth`, `user`, and `db`. Access with `c.get("auth")`, `c.get("user")`, `c.get("db")`. Always guard `user` for protected endpoints.
- Protected Routes Pattern: In `plan-router.ts`, a `planRoutes.use("*", ...)` middleware asserts auth; replicate for new secured routers.
- OpenAPI Route Definition: Use `createRoute` + `planRoutes.openapi(routeDef, handler)` and shared response helpers in `src/routers/openapi-helpers.ts` (e.g. `json200Response`). Ensure schemas use Zod; return JSON via `c.json(data, status)`.
- Stripe Data Loading: Stripe price amounts are fetched live per request in plan listing; consider caching if adding similar endpoints (avoid premature optimization in this repo unless hot path).
- JSON Fields in DB: `plans.limits` and `plans.freeTrial` stored as JSON strings; always `JSON.parse` when reading and `JSON.stringify` when writing.
- Dual Auth Environment: When `env` absent (CLI generation) `db` is `{}`; avoid executing queries in that mode—feature detection `if(env)` already used for stripe plugin inclusion.
- SPA Asset Fallback: For any non-matched path returning 404, worker rewrites to `/index.html`; keep this logic when adding new top-level routes (ensure API paths are exempt).
- Migrations: Drizzle migrations live in `/migrations` with snapshot metadata in `meta/`. Use existing scripts rather than manual edits.
- Scripts use `yarn` at root; frontend inside subfolder uses `npm` (scripts assume that). Keep consistency when adding new build steps.

## Developer Workflows
- Install: `yarn install` (root). Frontend build scripts internally run `npm install` inside `cite-met-app-frontend/`.
- Local Dev: `yarn build:frontend:dev` (populate `public/`), `yarn db:migrate:dev`, then `yarn dev` (wrangler dev at 8787). Sync OpenAPI for frontend consumption: `node sync-openapi.js` (fetches `/doc` -> writes `cite-met-app-frontend/openapi.yml`).
- Deploy: `yarn build:frontend && yarn deploy` (Cloudflare publish; minify enabled).
- DB Migration Generation: `yarn db:generate` (drizzle-kit from `src/db/index.ts`), then apply via dev or prod migrate scripts.
- Auth Schema Update: `yarn auth:update` (generate & format) after modifying `src/auth/index.ts` plugin config.
- Type Generation for Env Bindings: `yarn cf-typegen` regenerates `CloudflareBindings` interface.

## Adding a New API Router (Example Pattern)
1. Create `src/routers/my-feature-router.ts` using `new OpenAPIHono<{ Bindings: CloudflareBindings; Variables: Variables }>()`.
2. Add auth guard middleware if protected like in `plan-router.ts`.
3. Define routes with `createRoute` + Zod schemas.
4. Export `myFeatureRoutes` and mount in `src/index.ts` with `app.route("/api/my-feature/", myFeatureRoutes)`. Keep trailing slash to match existing pattern.
5. If new tables needed: update Drizzle schema files (`schema.ts` or new file), run `yarn db:generate`, apply migrations.

## External Integrations
- Stripe: Secret/key from `env.STRIPE_SECRET_KEY`. API version pinned (`2025-08-27.basil`). Plan enrichment occurs at request time—maintain version & error handling (wrap `stripeClient.prices.retrieve` if adding more calls).
- Resend (emails) & React Email components likely used (see dependency) though email templates currently in `src/emails/` (e.g., `sign-in-link.ts`). Follow existing template style.
- Sentry: Global middleware; no manual instrumentation present—can add spans via Hono context if needed.

## Error & Rate Handling
- Better Auth rate limiting enabled globally; rely on it for auth endpoints (don’t duplicate logic).
- Manual error responses use helpers (`json400Response`, etc.). Reuse rather than ad-hoc objects for consistency in OpenAPI output.

## Performance & Safety Notes
- Avoid heavy synchronous work in middleware; auth + session retrieval already occurs every request.
- When expanding DB usage, ensure queries use Drizzle’s compiled methods (`select().from(table)`); avoid raw SQL unless necessary.
- Preserve middleware order (Sentry early for tracing, auth after CORS so cookies accessible).

## File References (Jumpstart)
- Worker entry: `src/index.ts`
- Auth config: `src/auth/index.ts`
- DB schema aggregation: `src/db/index.ts`
- Payment tables: `src/db/payment.schema.ts`
- Router example: `src/routers/plan-router.ts`
- Response helpers: `src/routers/openapi-helpers.ts`
- Build scripts: `build-frontend.sh`, `build-frontend-dev.sh`
- OpenAPI sync: `sync-openapi.js`
- Drizzle config: `drizzle.config.ts`
- Wrangler config: `wrangler.jsonc`

## Non-Obvious Gotchas
- Local D1 path discovery in `drizzle.config.ts` depends on `.wrangler` internal sqlite file—ensure `wrangler dev` has run before `yarn db:generate` locally.
- Frontend build scripts delete and recreate `public/`; don’t manually place persistent backend assets outside `public/` expecting them to survive builds.
- Auth cookie attributes enforce `secure` + `SameSite=None`; cross-origin dev requires HTTPS or sandbox environment—be cautious altering.

Feedback welcome: Clarify any section or request deeper dives (e.g. core schema tables) and this guide can iterate.
